--source include/windows.inc

let $target_name=MARIADB/u@localhost:$MASTER_MYPORT;

--echo # cleanup credential manager just in case last run crashed in the middle
--error 0,1
exec cmdkey /delete:$target_name > /dev/null 2>&1;

CREATE USER 'u' IDENTIFIED BY 'pass';
-- echo # Login with correct password to store it
let MARIADB_CREDMGR_SAVE_PASSWORD=1;
exec $EXE_MYSQL --protocol=tcp --credential_manager=1 --port=$MASTER_MYPORT -uu --password=pass -e "do 1";
let MARIADB_CREDMGR_SAVE_PASSWORD=;

--echo # Check expected key is in the credential manager
exec cmdkey /list:$target_name > /dev/null;

--echo # Login without passing password (succeeds)
exec $EXE_MYSQL --credential_manager=1 --port=$MASTER_MYPORT -uu -e "do 1";

--echo # Login with -P ("interactively"), does not ask for password
exec $EXE_MYSQL --credential_manager=1 --port=$MASTER_MYPORT -uu -p -e "do 1";

--echo # Login with wrong password (fails)
--error 1
exec EXE_MYSQL --credential_manager=1 --protocol=tcp --port=$MASTER_MYPORT -uu --password=wrong -e "do 1";

--echo # Remove entry from credential manager
exec cmdkey /delete:$target_name > /dev/null;

--echo # Login without passing password (fails, credential is no longer in credential manager)
--error 1
exec $EXE_MYSQL --credential-manager=1 --port=$MASTER_MYPORT -uu -e "do 1";
DROP USER u;
